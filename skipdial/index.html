<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SkipDial</title>
<style>
:root{
  --bg:#0b0f1a;--bg2:#111827;--bg3:#1a2030;--border:#1e2636;
  --text:#e8eaf0;--dim:#8b95a5;--accent:#3b82f6;--green:#10b981;
  --red:#ef4444;--yellow:#eab308;--orange:#f97316;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Segoe UI',sans-serif;
  background:var(--bg);color:var(--text);min-height:100vh;
  min-height:-webkit-fill-available;overflow:hidden;
}
html{height:-webkit-fill-available}

/* Full height app shell */
#app{display:flex;flex-direction:column;height:100vh;height:100dvh}

/* Toast */
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--green);color:#fff;padding:8px 20px;border-radius:8px;
  font-weight:600;font-size:0.85rem;z-index:999;white-space:nowrap;
  transition:opacity 0.3s;pointer-events:none;
}
.toast.error{background:var(--red)}
.toast.hidden{opacity:0}

/* Shared */
.btn{
  padding:12px 20px;border-radius:10px;font-weight:800;font-size:0.95rem;
  cursor:pointer;font-family:inherit;border:none;transition:all .15s;
}
.btn:active{transform:scale(0.97)}
.btn-green{background:var(--green);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-accent{background:var(--accent);color:#fff}
.btn-outline{background:none;border:2px solid var(--border);color:var(--text)}

/* ===== UPLOAD VIEW ===== */
.upload-view{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:20px;text-align:center;
}
.upload-view h1{font-size:1.5rem;font-weight:800;margin-bottom:4px}
.upload-view h1 span{color:var(--accent)}
.upload-view p{color:var(--dim);font-size:0.85rem;margin-bottom:24px}
.upload-box{
  border:2px dashed #2a3040;border-radius:12px;padding:40px 20px;
  cursor:pointer;background:var(--bg2);width:100%;max-width:400px;
}
.upload-box:active{border-color:var(--accent)}
.upload-box .icon{font-size:2rem;margin-bottom:8px}
.upload-box .label{font-weight:600}
.upload-box .hint{color:var(--dim);font-size:0.8rem;margin-top:4px}
.demo-link{color:var(--accent);font-size:0.85rem;cursor:pointer;text-decoration:underline;margin-top:16px}

/* ===== LIST VIEW ===== */
.list-header{
  padding:12px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;flex-shrink:0;
}
.list-header h2{font-size:1.1rem;font-weight:800;flex:1}
.list-header h2 span{color:var(--accent)}
.list-header .count{font-size:0.8rem;color:var(--dim)}

.list-actions{
  padding:10px 16px;border-bottom:1px solid var(--border);
  display:flex;gap:8px;flex-shrink:0;
}
.list-actions .btn{flex:1;text-align:center}

.search-bar{padding:8px 16px;flex-shrink:0}
.search-bar input{
  width:100%;padding:10px 12px;border-radius:8px;
  border:1px solid #2a3040;background:var(--bg2);color:var(--text);
  font-size:0.9rem;font-family:inherit;
}

.lead-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.lead-row{
  padding:12px 16px;border-bottom:1px solid #1a2030;
  display:flex;align-items:center;gap:10px;cursor:pointer;
}
.lead-row:active{background:rgba(59,130,246,0.06)}
.lead-info{flex:1;min-width:0}
.lead-name{font-weight:700;font-size:0.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lead-meta{font-size:0.78rem;color:var(--dim);margin-top:2px}
.lead-right{text-align:right;flex-shrink:0}
.lead-time{font-size:0.7rem;font-weight:700}
.lead-status{
  display:inline-block;padding:2px 8px;border-radius:4px;
  font-size:0.7rem;font-weight:700;margin-top:3px;
}

/* ===== CALLING VIEW ===== */
.call-header{
  padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.call-header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.call-header .power-label{font-weight:800;color:var(--green);font-size:0.85rem}
.call-header .lead-num{font-weight:700;color:var(--accent);font-size:0.82rem}
.progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s}
.call-stats{display:flex;justify-content:space-between;margin-top:3px;font-size:0.72rem;color:var(--dim)}

/* Lead card */
.lead-card{padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.lead-card .name{font-size:1.3rem;font-weight:800}
.lead-card .details{font-size:0.82rem;color:var(--dim);margin-top:2px}
.lead-card .notes{font-size:0.78rem;color:var(--dim);padding:5px 8px;background:var(--bg2);border-radius:6px;margin-top:6px}

/* Call control */
.call-control{padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.dial-btn{
  display:block;width:100%;padding:14px;border-radius:10px;
  font-weight:800;font-size:1.05rem;text-align:center;
  text-decoration:none;cursor:pointer;border:none;font-family:inherit;
  transition:all .15s;
}
.dial-btn:active{transform:scale(0.97)}
.dial-btn.calling{background:var(--green);color:#fff;animation:pulse 2s infinite}
.dial-btn.ringing{background:var(--yellow);color:#000;animation:pulse 1.5s infinite}
.dial-btn.connected{background:var(--accent);color:#fff}
.dial-btn.idle{background:var(--green);color:#fff}
.dial-btn.ended{background:var(--bg3);color:var(--dim);border:1px solid var(--border)}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.85}}

.hangup-btn{
  display:block;width:100%;padding:10px;border-radius:8px;
  background:var(--red);color:#fff;font-weight:700;font-size:0.9rem;
  text-align:center;cursor:pointer;border:none;font-family:inherit;margin-top:6px;
}
.call-timer{text-align:center;font-size:0.85rem;color:var(--dim);margin-top:6px;font-weight:600}

/* Quick disposition */
.dispositions{padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.dispositions .label{font-size:0.78rem;color:var(--dim);margin-bottom:6px;font-weight:600}
.disp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.disp-btn{
  padding:12px 6px;border-radius:8px;font-weight:800;font-size:0.85rem;
  cursor:pointer;font-family:inherit;transition:all .1s;background:none;
}
.disp-btn:active{transform:scale(0.95)}

/* Nav controls */
.nav-controls{
  padding:6px 16px;display:flex;gap:6px;
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.nav-btn{
  flex:1;padding:8px;border-radius:6px;border:1px solid #2a3040;
  background:none;font-weight:700;font-size:0.82rem;cursor:pointer;
  font-family:inherit;color:var(--text);
}
.nav-btn:disabled{color:#3a4050;cursor:not-allowed}
.nav-btn.pause{border-color:var(--yellow);color:var(--yellow)}
.nav-btn.resume{border-color:var(--green);color:var(--green)}
.nav-btn.stop{border-color:var(--red);color:var(--red)}

/* Script section */
.script-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 12px}
.script-step{margin-bottom:6px;border-radius:8px;background:var(--bg2);border:1px solid var(--border);overflow:hidden}
.script-step-header{
  padding:10px 12px;cursor:pointer;display:flex;
  justify-content:space-between;align-items:center;
}
.script-step-header span{font-weight:700;font-size:0.88rem}
.script-step-header .arrow{color:var(--dim);font-size:0.8rem}
.script-step-body{
  padding:10px 12px;font-size:0.82rem;line-height:1.6;
  white-space:pre-wrap;color:#cbd5e1;border-top:1px solid var(--border);
}

/* Session summary */
.summary{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.summary h2{font-size:1.3rem;font-weight:800;margin-bottom:16px}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:300px;margin-bottom:24px}
.summary-stat{text-align:center;padding:12px;background:var(--bg2);border-radius:10px}
.summary-stat .num{font-size:1.5rem;font-weight:800}
.summary-stat .lbl{font-size:0.78rem;color:var(--dim);margin-top:2px}

/* Connection status */
.conn-status{
  position:fixed;top:8px;right:8px;padding:4px 10px;
  border-radius:6px;font-size:0.7rem;font-weight:700;z-index:50;
}
.conn-status.connected{background:rgba(16,185,129,0.15);color:var(--green)}
.conn-status.disconnected{background:rgba(239,68,68,0.15);color:var(--red)}
.conn-status.connecting{background:rgba(234,179,8,0.15);color:var(--yellow)}
</style>
</head>
<body>

<div id="app"></div>

<!-- Telnyx WebRTC SDK -->
<script src="https://unpkg.com/@telnyx/webrtc@2.9.0/lib/bundle.js"></script>

<script>
// ============================================================
// VETSCRIPT POWER DIALER ‚Äî Telnyx WebRTC Edition
// ============================================================

// ===== CONFIG =====
const API_BASE = ''; // Same origin when deployed to Vercel. Change for local dev.

// ===== STATE =====
const STATE = {
  view: 'upload', // upload | list | calling | summary
  leads: [],
  queue: [],
  queueIdx: 0,
  called: new Set(),
  stats: { calls:0, vms:0, appts:0, sold:0, notint:0, bad:0, callbacks:0 },
  paused: false,
  search: '',
  openSteps: {},
  sheetName: '',
  // Telnyx
  telnyxClient: null,
  telnyxReady: false,
  currentCall: null,
  callState: 'idle', // idle | calling | ringing | connected | ended
  callTimer: 0,
  callTimerInterval: null,
  // AMD
  lastAMDResult: null
};

// ===== CONSTANTS =====
const TZ={CT:-5,DE:-5,FL:-5,GA:-5,IN:-5,KY:-5,ME:-5,MD:-5,MA:-5,MI:-5,NH:-5,NJ:-5,NY:-5,NC:-5,OH:-5,PA:-5,RI:-5,SC:-5,VT:-5,VA:-5,WV:-5,DC:-5,AL:-6,AR:-6,IL:-6,IA:-6,KS:-6,LA:-6,MN:-6,MS:-6,MO:-6,NE:-6,ND:-6,OK:-6,SD:-6,TN:-6,TX:-6,WI:-6,AZ:-7,CO:-7,ID:-7,MT:-7,NM:-7,UT:-7,WY:-7,CA:-8,NV:-8,OR:-8,WA:-8,AK:-9,HI:-10};
const STNAMES={AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',CO:'Colorado',CT:'Connecticut',DE:'Delaware',FL:'Florida',GA:'Georgia',HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming',DC:'Washington DC'};
const STATUSES=['NEW LEAD','Follow Up','Scheduled Appt','1x VM','2x VM','3x VM','Bad #','Not Interested','SOLD','DNC','3x No VM','3x 5th round','Already Covered/Irreplaceable'];
const SBG={'SOLD':'#00B050','Scheduled Appt':'#92D050','3x VM':'#FFE699','Follow Up':'#FFF2CC','Bad #':'#FF0000','Not Interested':'#FFC7CE','NEW LEAD':'#DDEBF7','1x VM':'#FFF2CC','2x VM':'#FFE699','3x No VM':'#FFF2CC','3x 5th round':'#F4B084','Already Covered/Irreplaceable':'#C6E0B4','DNC':'#FF0000'};
const STX={'SOLD':'#fff','Bad #':'#fff','DNC':'#fff'};
const QBTNS=[{l:'üì± VM',s:'auto_vm',c:'#eab308'},{l:'üîÑ Callback',s:'Follow Up',c:'#3b82f6'},{l:'‚úã Not Int',s:'Not Interested',c:'#ef4444'},{l:'‚ùå Bad #',s:'Bad #',c:'#ef4444'},{l:'üìÖ Appt',s:'Scheduled Appt',c:'#10b981'},{l:'üí∞ SOLD',s:'SOLD',c:'#10b981'}];

// ===== HELPERS =====
function $(id){return document.getElementById(id)}
function cw(s){const o=TZ[s]||-5,n=new Date(),u=n.getTime()+(n.getTimezoneOffset()*60000),m=n.getMonth(),d=(m>=2&&m<=10&&s!=='AZ'&&s!=='HI')?1:0,t=new Date(u+((o+d)*3600000)),h=t.getHours(),ts=t.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});if(h<8)return{s:0,l:'üåô',t:ts,c:'#ef4444'};if(h<10)return{s:10,l:'üî•',t:ts,c:'#10b981'};if(h<12)return{s:9,l:'‚úÖ',t:ts,c:'#10b981'};if(h<14)return{s:7,l:'üçΩÔ∏è',t:ts,c:'#eab308'};if(h<17)return{s:8,l:'‚úÖ',t:ts,c:'#3b82f6'};if(h<19)return{s:6,l:'üåÖ',t:ts,c:'#f59e0b'};if(h<21)return{s:3,l:'üåÜ',t:ts,c:'#f97316'};return{s:0,l:'üõë',t:ts,c:'#ef4444'};}
function fmt(p){const d=(p||'').replace(/\D/g,'').replace(/^1/,'');return d.length===10?`(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`:p;}
function fn(n){return(n||'').split(' ')[0];}
function e164(p){return'+1'+(p||'').replace(/\D/g,'').replace(/^1/,'');}

let toastTimer;
function showToast(msg, isError){
  let t = $('toast');
  if(!t){t=document.createElement('div');t.id='toast';t.className='toast hidden';document.body.appendChild(t);}
  t.textContent=msg;
  t.className='toast'+(isError?' error':'');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.className='toast hidden',2500);
}

// ===== CSV PARSER =====
function parseCSV(text){
  const L=text.split(/\r?\n/).filter(l=>l.trim());if(L.length<2)return[];
  const sep=L[0].includes('\t')?'\t':',';
  const H=L[0].split(sep).map(h=>h.replace(/"/g,'').trim().toUpperCase());
  const ni=H.findIndex(h=>h.includes('NAME')),pi=H.findIndex(h=>h.includes('PHONE')),di=H.findIndex(h=>h.includes('DOB')),si=H.findIndex(h=>h.includes('STATE')),sti=H.findIndex(h=>h.includes('STATUS')),noi=H.findIndex(h=>h.includes('NOTE'));
  if(ni<0||pi<0)return[];
  const R=[];
  for(let i=1;i<L.length;i++){
    const c=L[i].split(sep).map(x=>x.replace(/"/g,'').trim());
    const nm=c[ni]||'',ph=(c[pi]||'').replace(/\D/g,'');
    if(!nm||!ph||ph.length<7)continue;
    const db=di>=0?c[di]:'',st=si>=0?(c[si]||'').toUpperCase().substring(0,2):'',ss=sti>=0?(c[sti]||'NEW LEAD'):'NEW LEAD',no=noi>=0?(c[noi]||''):'';
    let a=0;if(db){const p=db.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);if(p){let y=parseInt(p[3]);if(y<100)y+=y>25?1900:2000;a=Math.floor((Date.now()-new Date(y,parseInt(p[1])-1,parseInt(p[2])).getTime())/(365.25*86400000));}}
    R.push({id:crypto.randomUUID(),name:nm,phone:ph,dob:db,age:a,state:st,status:STATUSES.find(x=>x.toLowerCase()===ss.toLowerCase().trim())||'NEW LEAD',notes:no,vm:0});
  }
  return R;
}

// ===== TELNYX CLIENT =====
async function initTelnyx(){
  try {
    showToast('Connecting to Telnyx...');
    const res = await fetch(API_BASE + '/api/token');
    if(!res.ok) throw new Error('Token fetch failed');
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const client = new TelnyxWebRTC.TelnyxRTC({
      login_token: data.token
    });

    client.on('telnyx.ready', () => {
      STATE.telnyxReady = true;
      showToast('üìû Dialer connected!');
      render();
    });

    client.on('telnyx.error', (err) => {
      console.error('Telnyx error:', err);
      STATE.telnyxReady = false;
      showToast('Dialer connection error', true);
      render();
    });

    client.on('telnyx.notification', (notification) => {
      handleTelnyxNotification(notification);
    });

    client.on('telnyx.socket.close', () => {
      STATE.telnyxReady = false;
      render();
    });

    client.connect();
    STATE.telnyxClient = client;
  } catch(err) {
    console.error('Telnyx init error:', err);
    showToast('Failed to connect dialer: ' + err.message, true);
  }
}

function handleTelnyxNotification(notification) {
  const call = notification.call;
  if (!call) return;

  switch(notification.type) {
    case 'callUpdate':
      if (call.state === 'ringing') {
        STATE.callState = 'ringing';
      } else if (call.state === 'active') {
        STATE.callState = 'connected';
        startCallTimer();
      } else if (call.state === 'hangup' || call.state === 'destroy') {
        STATE.callState = 'ended';
        stopCallTimer();
        STATE.currentCall = null;
      }
      render();
      break;
  }
}

function dialNumber(phoneNumber) {
  if (!STATE.telnyxClient || !STATE.telnyxReady) {
    // Fallback to tel: link if WebRTC not connected
    window.location.href = 'tel:' + e164(phoneNumber);
    STATE.callState = 'calling';
    render();
    return;
  }

  try {
    STATE.callState = 'calling';
    render();

    const call = STATE.telnyxClient.newCall({
      destinationNumber: e164(phoneNumber),
      callerName: 'SkipDial',
      callerNumber: '', // Will use the Telnyx number
    });

    STATE.currentCall = call;
    showToast('üìû Dialing...');
  } catch(err) {
    console.error('Dial error:', err);
    showToast('Dial failed: ' + err.message, true);
    STATE.callState = 'idle';
    render();
  }
}

function hangupCall() {
  if (STATE.currentCall) {
    try { STATE.currentCall.hangup(); } catch(e) {}
    STATE.currentCall = null;
  }
  STATE.callState = 'ended';
  stopCallTimer();
  render();
}

function startCallTimer(){
  STATE.callTimer = 0;
  clearInterval(STATE.callTimerInterval);
  STATE.callTimerInterval = setInterval(()=>{
    STATE.callTimer++;
    const el = $('callTimer');
    if(el){
      const m=Math.floor(STATE.callTimer/60);
      const s=STATE.callTimer%60;
      el.textContent=`${m}:${s<10?'0':''}${s}`;
    }
  },1000);
}

function stopCallTimer(){
  clearInterval(STATE.callTimerInterval);
}

// ===== SCRIPT GENERATOR =====
function genScript(l){
  const f=fn(l.name),full=l.name,stF=STNAMES[l.state]||l.state,dob=l.dob||'___',age=l.age;
  let tone=age>=75?`${f}, you've served this country and earned peace of mind.`:age>=65?`${f}, perfect age to lock this in while rates are in your favor.`:age>=55?`${f}, you're getting ahead of this ‚Äî most people wait until it's too late.`:`${f}, rates only go up from here.`;
  return[
{title:'üìû Intro',body:`Hey ${f}, this is _(your name)_ with the Veterans Benefits Office. You doing alright today?\n\nJust giving you a call about Final Expense and Life options for Veterans. I've got your DOB as ${dob}. Is that correct?\n\nAnd you're still in ${stF}, correct?\n\nYour main concern was making sure funeral expense doesn't burden your loved ones, correct?`},
{title:'üõ°Ô∏è Intro Objections',collapsed:true,body:`"10th person that called me!"\nMust have been a telemarketer ‚Äî nobody contacted you from our office.\n\n"Already have coverage!"\nPerfect ‚Äî Veteran benefit office or private? How much? What paying/month?\n\n"Don't remember filling this out!"\nI usually don't remember breakfast! DOB as ${dob}, correct?\n\n"Not interested!"\nWhat was your main concern when you sent the request? Any coverage currently?\n\n"Not a good time!"\nWe're backed up too! I'll make this quick.\n\n"VA will take care of burial"\nCommon misconception. VA just covers the plot. Avg burial $12K‚Äì$25K, cremation $5K‚Äì$8K.\n\n"Send me info"\nNothing to send yet ‚Äî every plan differs. Takes a few minutes. Fair enough?\n\n"Is this a scam?"\nFair question. Licensed agent in ${stF}. A-rated carriers.`},
{title:'üí° Dig Into The Why',body:`God forbid you passed today ‚Äî who'd be responsible for funeral expenses?\n\n‚Ä¢ Name? Spell that?\n‚Ä¢ Is (beneficiary) in a position to cover it?\n\n${tone}\n\nBuried or cremated? Know how much?\n‚Ä¢ Cremation: $5K‚Äì$8K\n‚Ä¢ Burial: $12K‚Äì$25K\n\nAnything put aside?\n\nüîë Your goal is to not leave a financial burden behind, correct?`},
{title:'üìã Suitability',body:`1. Working, retired, or disabled?\n2. Bring in per month ballpark?\n3. Left with after bills?\n\nLow income: "If you can't afford $50-75/mo how do you expect (Beneficiary) to afford the funeral?"\n\nTwo DISCOUNTS:\n1. Smoker or nonsmoker?\n2. Military credit union or state/federal bank?`},
{title:'üè• Health Questions',body:`VA or civilian doctor?\n\n‚Ä¢ Heart attacks, strokes, stents last 5 yrs?\n‚Ä¢ Cancer last 5 years?\n‚Ä¢ Diabetes? Metformin/insulin?\n‚Ä¢ Neuropathy? Gabapentin?\n‚Ä¢ COPD? Oxygen/inhaler?\n‚Ä¢ Kidney/liver problems? Dialysis?\n‚Ä¢ Height and weight?\n\n"Running this through all the carriers for cheapest rate..."`},
{title:'‚úÖ Benefits ‚Äî Pen & Paper',body:`1. IMMEDIATE COVERAGE ‚Äî day 1, no 2yr wait!\n2. LOCKED IN ‚Äî never increases, never decreases!\n3. TAX-FREE ‚Äî death benefit, living benefit, cash value!\n4. LIVING BENEFIT ‚Äî terminal illness, 50% tax free!\n5. DOUBLE ACCIDENTAL ‚Äî choke, drown, slip, fall = double!\n6. PERMANENT ‚Äî whole life, never expires!`},
{title:'üí∞ Quote',body:`ü•â BRONZE ‚Äî covers full funeral. $___/mo.\n\nü•à SILVER ‚Äî extra for bills + inflation. $___/mo.\n\nü•á GOLD ‚Äî (Beneficiary) fully taken care of. $___/mo.\n\nüîë Which fits you best? BRONZE... SILVER... OR GOLD?`},
{title:'üõ°Ô∏è Quote Objections',collapsed:true,body:`"Think about it" ‚Üí Need it or which amount? Start bare minimum.\n\n"Talk to wife" ‚Üí She's beneficiary. Paperwork in 7-10 days. If something happened tomorrow ‚Äî would she be mad?\n\n"Shopping around" ‚Üí Can't buy today anyway. Have to get approved. Lowest rate.\n\n"No money" ‚Üí When do you get benefits? Effective date matches. Nothing today.\n\n"Call you back" ‚Üí Rates locked by age. 30-day free look, full refund.\n\n"Too expensive" ‚Üí Which package? Bronze = less than a cable bill.`},
{title:'üìù Application',body:`üîë Been thinking about this for awhile?\n\n‚Ä¢ Spelling: ${full}\n‚Ä¢ Height/weight\n‚Ä¢ Address (house/apt?)\n‚Ä¢ Phone, email\n‚Ä¢ State & city born in\n‚Ä¢ US Citizen! (joke)\n‚Ä¢ Social ${f}? (Repeat back)\n\nSSN: "For medical background check + death certificate to pay (Beneficiary)."\nPush: "Confirm the last four."`},
{title:'üè• Health Fillers',body:`‚Ä¢ Help walking? Cane/wheelchair?\n‚Ä¢ Oxygen?\n‚Ä¢ Help with daily activities?\n‚Ä¢ COVID last 90 days?\n‚Ä¢ Alcohol/drug abuse?\n‚Ä¢ Alzheimers/Dementia?\n‚Ä¢ AIDS/HIV? Hepatitis?\n‚Ä¢ Brain tumor/aneurysm?\n‚Ä¢ Dangerous activities next 2 years?`},
{title:'‚ù§Ô∏è Beneficiary',body:`Confirm beneficiary, spelling, relationship, DOB, %\n\nSPOUSE: How long married? Tips? Grandkids?\nCHILD: See them often? Grandkids?\n\nüîë What got you thinking about this for (beneficiary)?`},
{title:'üí≥ Billing',body:`When do you get benefits? Set effective date.\n\n‚Ä¢ Name same with bank?\n‚Ä¢ Bank name? Checking/savings?\n‚Ä¢ Checkbook ‚Äî confirm routing\n‚Ä¢ Account #? REPEAT TWICE.\n\nNo checkbook ‚Üí debit card for now.\n\nObjection: "Ever given a check? That info can't buy anything online."\n\n"Don't give bank info" ‚Üí Secure link or debit card.`},
{title:'üîí Close + Referrals',body:`Everything submitted. Coverage for _XXX_, carrier _XXX_.\n\nThis is my direct line. Phone call or text away.\n\nPolicy in mail 10-12 days. I'll text you.\n\n$50 VISA referral fee ‚Äî know one or two people?\n\nAny questions? Blessed day!`}
  ];
}

// ===== QUEUE LOGIC =====
function buildQueue(){
  const skip=['SOLD','Bad #','Not Interested','DNC','Already Covered/Irreplaceable'];
  return STATE.leads.filter(l=>!skip.includes(l.status)&&cw(l.state).s>0).map(l=>l.id);
}

function startDialing(fromId){
  const q=buildQueue();
  if(!q.length){showToast('No callable leads');return;}
  const si=fromId?Math.max(q.indexOf(fromId),0):0;
  STATE.queue=q;STATE.queueIdx=si;STATE.called=new Set();
  STATE.stats={calls:0,vms:0,appts:0,sold:0,notint:0,bad:0,callbacks:0};
  STATE.paused=false;STATE.openSteps={};STATE.callState='idle';
  STATE.view='calling';
  render();
  // Auto-dial first lead
  setTimeout(()=>{
    const lead=STATE.leads.find(x=>x.id===q[si]);
    if(lead){
      STATE.called.add(q[si]);
      dialNumber(lead.phone);
    }
  },500);
}

function disposition(status){
  const lid=STATE.queue[STATE.queueIdx];
  const lead=STATE.leads.find(l=>l.id===lid);
  if(!lead)return;

  // Hangup current call if active
  hangupCall();

  let ns=status;
  if(status==='auto_vm'){lead.vm=(lead.vm||0)+1;ns=lead.vm===1?'1x VM':lead.vm===2?'2x VM':'3x VM';}
  lead.status=ns;
  STATE.called.add(lid);

  // Update stats
  STATE.stats.calls++;
  if(ns.includes('VM'))STATE.stats.vms++;
  if(ns==='Scheduled Appt')STATE.stats.appts++;
  if(ns==='SOLD')STATE.stats.sold++;
  if(ns==='Not Interested')STATE.stats.notint++;
  if(ns==='Bad #')STATE.stats.bad++;
  if(ns==='Follow Up')STATE.stats.callbacks++;

  showToast(`${fn(lead.name)} ‚Üí ${ns}`);

  // Auto advance
  const ni=STATE.queueIdx+1;
  if(ni<STATE.queue.length&&!STATE.paused){
    setTimeout(()=>{
      STATE.queueIdx=ni;STATE.openSteps={};STATE.callState='idle';
      render();
      const nl=STATE.leads.find(l=>l.id===STATE.queue[ni]);
      if(nl){
        STATE.called.add(STATE.queue[ni]);
        setTimeout(()=>dialNumber(nl.phone),300);
      }
    },800);
  } else if(ni>=STATE.queue.length){
    STATE.view='summary';render();
  } else {
    render();
  }
}

function skipLead(){
  hangupCall();
  const ni=STATE.queueIdx+1;
  if(ni<STATE.queue.length){
    STATE.queueIdx=ni;STATE.openSteps={};STATE.callState='idle';render();
    const nl=STATE.leads.find(l=>l.id===STATE.queue[ni]);
    if(nl)setTimeout(()=>dialNumber(nl.phone),300);
  }
}

function stopDialer(){
  hangupCall();
  STATE.view='summary';
  render();
}

// ===== RENDER =====
function render(){
  const app=$('app');
  if(STATE.view==='upload') return renderUpload(app);
  if(STATE.view==='list') return renderList(app);
  if(STATE.view==='calling') return renderCalling(app);
  if(STATE.view==='summary') return renderSummary(app);
}

function renderUpload(app){
  app.innerHTML=`
    <div class="upload-view">
      <h1>üá∫üá∏ Skip<span>Dial</span></h1>
      <p>Power dialer + script. Upload CSV to start.</p>
      <div class="upload-box" onclick="document.getElementById('csvFile').click()">
        <div class="icon">üìÅ</div>
        <div class="label">Tap to upload CSV</div>
        <div class="hint">NAME, PHONE, DOB, STATE, STATUS</div>
        <input type="file" id="csvFile" accept=".csv,.tsv,.txt" style="display:none" onchange="handleFile(event)">
      </div>
      <div class="demo-link" onclick="loadDemo()">Load demo data ‚Üí</div>
    </div>
    ${connStatusHTML()}
  `;
}

function renderList(app){
  const fl=STATE.search?STATE.leads.filter(l=>l.name.toLowerCase().includes(STATE.search.toLowerCase())||l.state.toLowerCase().includes(STATE.search.toLowerCase())):STATE.leads;
  const nc=buildQueue().length;
  app.innerHTML=`
    <div class="list-header">
      <h2>üá∫üá∏ <span>${STATE.sheetName||'Leads'}</span></h2>
      <span class="count">${STATE.leads.length} leads</span>
    </div>
    <div class="list-actions">
      <button class="btn btn-green" onclick="startDialing()">‚ö° Power Dial (${nc})</button>
      <button class="btn btn-outline" onclick="STATE.view='upload';STATE.leads=[];render()">+ New</button>
    </div>
    <div class="search-bar">
      <input id="searchInput" placeholder="Search..." value="${STATE.search}" oninput="STATE.search=this.value;render()">
    </div>
    <div class="lead-list">
      ${fl.map(l=>{
        const w=cw(l.state);
        return`<div class="lead-row" onclick="startDialing('${l.id}')">
          <div class="lead-info">
            <div class="lead-name">${l.name}</div>
            <div class="lead-meta">${l.age>0?l.age+'yo ¬∑ ':''}${l.state} ¬∑ ${fmt(l.phone)}</div>
          </div>
          <div class="lead-right">
            <div class="lead-time" style="color:${w.c}">${w.l} ${w.t}</div>
            <div class="lead-status" style="background:${SBG[l.status]||'#334155'};color:${STX[l.status]||'#000'}">${l.status}</div>
          </div>
        </div>`;
      }).join('')}
    </div>
    ${connStatusHTML()}
  `;
}

function renderCalling(app){
  const cur=STATE.queue[STATE.queueIdx]?STATE.leads.find(l=>l.id===STATE.queue[STATE.queueIdx]):null;
  if(!cur){STATE.view='summary';render();return;}
  const w=cw(cur.state);
  const pct=STATE.queue.length?Math.round((STATE.called.size/STATE.queue.length)*100):0;
  const script=genScript(cur);
  const cs=STATE.callState;

  let dialBtnClass='dial-btn idle';
  let dialBtnText=`üìû ${fmt(cur.phone)}`;
  if(cs==='calling'){dialBtnClass='dial-btn calling';dialBtnText='üìû Dialing...';}
  if(cs==='ringing'){dialBtnClass='dial-btn ringing';dialBtnText='üîî Ringing...';}
  if(cs==='connected'){dialBtnClass='dial-btn connected';dialBtnText='üîä Connected';}
  if(cs==='ended'){dialBtnClass='dial-btn ended';dialBtnText='Call Ended ‚Äî tap disposition';}

  app.innerHTML=`
    <div class="call-header">
      <div class="call-header-top">
        <span class="power-label">‚ö° POWER DIALER</span>
        <span class="lead-num">Lead ${STATE.queueIdx+1}/${STATE.queue.length}</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="call-stats">
        <span>${STATE.called.size} called</span>
        <span>${STATE.stats.appts} appts ¬∑ ${STATE.stats.sold} sold ¬∑ ${STATE.stats.vms} VMs</span>
      </div>
    </div>

    <div class="lead-card">
      <div class="name">${cur.name}</div>
      <div class="details">${cur.age>0?'Age '+cur.age+' ¬∑ ':''}${STNAMES[cur.state]||cur.state} <span style="color:${w.c};font-weight:700">¬∑ ${w.l} ${w.t}</span></div>
      ${cur.notes?'<div class="notes">üìù '+cur.notes+'</div>':''}
    </div>

    <div class="call-control">
      <button class="${dialBtnClass}" onclick="${cs==='idle'||cs==='ended'?`dialNumber('${cur.phone}')`:''}">
        ${dialBtnText}
      </button>
      ${cs==='connected'||cs==='calling'||cs==='ringing'?'<button class="hangup-btn" onclick="hangupCall()">üî¥ Hang Up</button>':''}
      ${cs==='connected'?'<div class="call-timer" id="callTimer">0:00</div>':''}
    </div>

    <div class="dispositions">
      <div class="label">TAP TO DISPOSITION & AUTO-DIAL NEXT:</div>
      <div class="disp-grid">
        ${QBTNS.map(b=>`<button class="disp-btn" style="border:2px solid ${b.c};color:${b.c}" onclick="disposition('${b.s}')">${b.l}</button>`).join('')}
      </div>
    </div>

    <div class="nav-controls">
      <button class="nav-btn" onclick="if(STATE.queueIdx>0){hangupCall();STATE.queueIdx--;STATE.openSteps={};STATE.callState='idle';render();const p=STATE.leads.find(l=>l.id===STATE.queue[STATE.queueIdx]);if(p)setTimeout(()=>dialNumber(p.phone),300);}" ${STATE.queueIdx<=0?'disabled':''}>‚óÄ Prev</button>
      <button class="nav-btn" onclick="skipLead()" ${STATE.queueIdx>=STATE.queue.length-1?'disabled':''}>Skip ‚ñ∂</button>
      <button class="nav-btn ${STATE.paused?'resume':'pause'}" onclick="STATE.paused=!STATE.paused;render()">${STATE.paused?'‚ñ∂ Go':'‚è∏ Pause'}</button>
      <button class="nav-btn stop" onclick="stopDialer()">‚èπ Stop</button>
    </div>

    <div class="script-area">
      ${script.map((s,i)=>{
        const isOpen=s.collapsed?!!STATE.openSteps[i]:STATE.openSteps[i]!==false;
        return`<div class="script-step">
          <div class="script-step-header" onclick="STATE.openSteps[${i}]=!STATE.openSteps[${i}];if(STATE.openSteps[${i}]===undefined)STATE.openSteps[${i}]=${s.collapsed?'true':'false'};render()">
            <span>${s.title}</span>
            <span class="arrow">${isOpen?'‚ñº':'‚ñ∂'}</span>
          </div>
          ${isOpen?`<div class="script-step-body">${s.body}</div>`:''}
        </div>`;
      }).join('')}
    </div>
    ${connStatusHTML()}
  `;
}

function renderSummary(app){
  const s=STATE.stats;
  app.innerHTML=`
    <div class="summary">
      <h2>üìä Session Complete</h2>
      <div class="summary-grid">
        <div class="summary-stat"><div class="num" style="color:var(--accent)">${s.calls}</div><div class="lbl">Total Calls</div></div>
        <div class="summary-stat"><div class="num" style="color:var(--yellow)">${s.vms}</div><div class="lbl">Voicemails</div></div>
        <div class="summary-stat"><div class="num" style="color:var(--green)">${s.appts}</div><div class="lbl">Appointments</div></div>
        <div class="summary-stat"><div class="num" style="color:var(--green)">${s.sold}</div><div class="lbl">Sold</div></div>
        <div class="summary-stat"><div class="num" style="color:var(--accent)">${s.callbacks}</div><div class="lbl">Callbacks</div></div>
        <div class="summary-stat"><div class="num" style="color:var(--red)">${s.notint+s.bad}</div><div class="lbl">Dead Leads</div></div>
      </div>
      <button class="btn btn-green" onclick="STATE.view='list';render()" style="width:100%;max-width:300px;margin-bottom:10px">Back to Lead List</button>
      <button class="btn btn-accent" onclick="startDialing()" style="width:100%;max-width:300px">‚ö° Dial Again</button>
    </div>
  `;
}

function connStatusHTML(){
  if(!STATE.telnyxClient) return '<div class="conn-status disconnected">üì° Not Connected</div>';
  if(STATE.telnyxReady) return '<div class="conn-status connected">üì° Connected</div>';
  return '<div class="conn-status connecting">üì° Connecting...</div>';
}

// ===== FILE HANDLING =====
function handleFile(e){
  const file=e.target.files[0];if(!file)return;
  STATE.sheetName=file.name.replace(/\.(csv|xlsx?|tsv|txt)$/i,'');
  const reader=new FileReader();
  reader.onload=ev=>{
    const parsed=parseCSV(ev.target.result);
    if(!parsed.length){showToast('No leads found ‚Äî check CSV format',true);return;}
    parsed.sort((a,b)=>(cw(b.state).s-cw(a.state).s)||(b.age-a.age));
    STATE.leads=parsed;STATE.view='list';
    showToast(`${parsed.length} leads loaded`);
    render();
    // Try to connect to Telnyx after loading leads
    if(!STATE.telnyxClient) initTelnyx();
  };
  reader.readAsText(file);
}

function loadDemo(){
  const d=[
    {id:'1',name:'Robert Johnson',phone:'5551234567',dob:'03/15/1948',age:77,state:'FL',status:'NEW LEAD',notes:'Wife Linda',vm:0},
    {id:'2',name:'James Williams',phone:'5559876543',dob:'07/22/1955',age:70,state:'TX',status:'Follow Up',notes:'COPD',vm:0},
    {id:'3',name:'William Davis',phone:'5552345678',dob:'11/03/1950',age:75,state:'CA',status:'NEW LEAD',notes:'',vm:0},
    {id:'4',name:'Charles Smith',phone:'5553456789',dob:'01/18/1960',age:66,state:'GA',status:'NEW LEAD',notes:'',vm:0},
    {id:'5',name:'Thomas Brown',phone:'5554567890',dob:'09/30/1952',age:73,state:'NC',status:'Follow Up',notes:'',vm:0},
    {id:'6',name:'Donald Taylor',phone:'5556789012',dob:'06/25/1958',age:67,state:'PA',status:'NEW LEAD',notes:'',vm:0},
    {id:'7',name:'Kenneth Martinez',phone:'5558901234',dob:'08/14/1945',age:80,state:'AL',status:'NEW LEAD',notes:'Vietnam',vm:0},
    {id:'8',name:'Mark Thompson',phone:'5551237890',dob:'05/20/1968',age:57,state:'AZ',status:'NEW LEAD',notes:'',vm:0},
  ];
  d.sort((a,b)=>cw(b.state).s-cw(a.state).s||(b.age-a.age));
  STATE.leads=d;STATE.sheetName='Demo';STATE.view='list';
  render();
  if(!STATE.telnyxClient) initTelnyx();
}

// ===== INIT =====
render();
</script>
</body>
</html>
