<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SkipDial</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&display=swap" rel="stylesheet">
<style>
/* ============================================================
   SKIPDIAL â€” Design Tokens
   ============================================================ */
:root {
  /* Surface colors â€” professional dark mode (Zinc scale) */
  --bg-base: #09090b;
  --bg-surface: #18181b;
  --bg-elevated: #27272a;
  --bg-hover: #3f3f46;

  /* Borders */
  --border: #27272a;
  --border-hover: #3f3f46;

  /* Text hierarchy */
  --text-primary: #fafafa;
  --text-secondary: #a1a1aa;
  --text-tertiary: #71717a;

  /* Accent â€” indigo */
  --accent: #6366f1;
  --accent-hover: #818cf8;
  --accent-muted: rgba(99, 102, 241, 0.12);

  /* Semantic */
  --success: #22c55e;
  --success-muted: rgba(34, 197, 94, 0.12);
  --warning: #eab308;
  --warning-muted: rgba(234, 179, 8, 0.12);
  --danger: #ef4444;
  --danger-muted: rgba(239, 68, 68, 0.12);
  --orange: #f97316;
  --orange-muted: rgba(249, 115, 22, 0.12);

  /* Typography */
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

  /* Spacing (4px base) */
  --sp-1: 4px; --sp-2: 8px; --sp-3: 12px; --sp-4: 16px;
  --sp-5: 20px; --sp-6: 24px; --sp-8: 32px; --sp-10: 40px;

  /* Radius */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --radius-xl: 20px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 30px rgba(99,102,241,0.2);

  /* Transitions */
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
  --duration: 200ms;
  --duration-slow: 350ms;
}

/* ============================================================
   Reset & Base
   ============================================================ */
*{margin:0;padding:0;box-sizing:border-box}
body {
  font-family: var(--font);
  background: var(--bg-base);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  overflow: hidden;
  font-size: 15px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
html{height:-webkit-fill-available}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh}

/* ============================================================
   Toast
   ============================================================ */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(0);
  background: var(--bg-elevated); color: var(--text-primary);
  padding: 10px 20px; border-radius: var(--radius-md);
  font-weight: 600; font-size: 0.85rem; z-index: 999;
  white-space: nowrap; pointer-events: none;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  transition: opacity 0.3s var(--ease), transform 0.3s var(--ease);
  border-left: 3px solid var(--success);
}
.toast.error { border-left-color: var(--danger); }
.toast.hidden { opacity: 0; transform: translateX(-50%) translateY(8px); }

/* ============================================================
   Buttons
   ============================================================ */
.btn {
  padding: 10px 20px; border-radius: var(--radius-md);
  font-weight: 600; font-size: 0.875rem; cursor: pointer;
  font-family: var(--font); border: none;
  transition: all var(--duration) var(--ease);
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-success { background: var(--success); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-ghost {
  background: transparent; border: 1px solid var(--border);
  color: var(--text-secondary);
}
.btn-ghost:hover { background: var(--bg-elevated); border-color: var(--border-hover); color: var(--text-primary); }

/* ============================================================
   Upload View
   ============================================================ */
.upload-view {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: var(--sp-5); text-align: center;
}
.upload-view h1 {
  font-size: 1.75rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: var(--sp-1);
}
.upload-view h1 span { color: var(--accent); }
.upload-view > p { color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: var(--sp-6); }
.upload-box {
  border: 1.5px dashed var(--border-hover); border-radius: var(--radius-lg);
  padding: 40px 24px; cursor: pointer; background: var(--bg-surface);
  width: 100%; max-width: 400px;
  transition: all var(--duration) var(--ease);
}
.upload-box:hover, .upload-box:active { border-color: var(--accent); background: rgba(99,102,241,0.04); }
.upload-box .icon { margin-bottom: var(--sp-3); color: var(--text-tertiary); }
.upload-box .label { font-weight: 600; font-size: 0.95rem; }
.upload-box .hint { color: var(--text-tertiary); font-size: 0.8rem; margin-top: var(--sp-1); }
.demo-link {
  color: var(--accent); font-size: 0.85rem; cursor: pointer;
  text-decoration: none; margin-top: var(--sp-5);
  transition: color var(--duration) var(--ease);
}
.demo-link:hover { color: var(--accent-hover); text-decoration: underline; }

/* ============================================================
   List View
   ============================================================ */
.list-header {
  padding: var(--sp-4); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: var(--sp-2); flex-shrink: 0;
}
.list-header h2 {
  font-size: 1.1rem; font-weight: 800; flex: 1; letter-spacing: -0.02em;
}
.list-header h2 span { color: var(--accent); }
.list-header .count { font-size: 0.8rem; color: var(--text-tertiary); }

.list-actions {
  padding: var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--border);
  display: flex; gap: var(--sp-2); flex-shrink: 0;
}
.list-actions .btn { flex: 1; text-align: center; }

.search-bar {
  padding: var(--sp-2) var(--sp-4); flex-shrink: 0;
  position: sticky; top: 0; z-index: 10;
  background: rgba(9,9,11,0.85);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
}
.search-wrap { position: relative; }
.search-wrap svg {
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
  color: var(--text-tertiary); pointer-events: none;
}
.search-bar input {
  width: 100%; padding: 10px 12px 10px 36px; border-radius: var(--radius-full);
  border: 1px solid var(--border); background: var(--bg-surface);
  color: var(--text-primary); font-size: 0.875rem; font-family: var(--font);
  transition: border-color var(--duration) var(--ease);
  outline: none;
}
.search-bar input:focus { border-color: var(--accent); }
.search-bar input::placeholder { color: var(--text-tertiary); }

.lead-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.lead-row {
  padding: var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: var(--sp-3); cursor: pointer;
  transition: background var(--duration) var(--ease);
}
.lead-row:hover { background: var(--bg-surface); }
.lead-row:active { background: var(--bg-elevated); }
.lead-info { flex: 1; min-width: 0; }
.lead-name {
  font-weight: 700; font-size: 0.95rem;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.lead-meta { font-size: 0.78rem; color: var(--text-tertiary); margin-top: 2px; }
.lead-right { text-align: right; flex-shrink: 0; }
.lead-time { font-size: 0.72rem; font-weight: 600; }
.lead-status {
  display: inline-block; padding: 2px 10px; border-radius: var(--radius-full);
  font-size: 0.68rem; font-weight: 600; margin-top: 3px;
}

/* ============================================================
   Calling View
   ============================================================ */
.call-header {
  padding: var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.call-header-top {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sp-1);
}
.call-header .power-label {
  font-weight: 800; color: var(--accent); font-size: 0.75rem;
  letter-spacing: 0.08em; text-transform: uppercase;
}
.call-header .lead-num { font-weight: 600; color: var(--text-tertiary); font-size: 0.8rem; }
.progress-bar {
  height: 3px; background: var(--bg-elevated); border-radius: var(--radius-full); overflow: hidden;
}
.progress-fill {
  height: 100%; border-radius: var(--radius-full);
  background: linear-gradient(90deg, var(--accent), var(--accent-hover));
  transition: width 0.4s var(--ease);
}
.call-stats {
  display: flex; justify-content: space-between; margin-top: var(--sp-1);
  font-size: 0.72rem; color: var(--text-tertiary);
}

/* Lead card */
.lead-card {
  padding: var(--sp-4); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.lead-card .name { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.02em; }
.lead-card .details { font-size: 0.82rem; color: var(--text-secondary); margin-top: var(--sp-1); }
.lead-card .notes {
  font-size: 0.78rem; color: var(--text-secondary);
  padding: var(--sp-2) var(--sp-3); background: var(--bg-surface);
  border-radius: var(--radius-sm); margin-top: var(--sp-2);
  border: 1px solid var(--border);
}

/* Call control */
.call-control { padding: var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.dial-btn {
  display: block; width: 100%; padding: 14px; border-radius: var(--radius-md);
  font-weight: 700; font-size: 1rem; text-align: center;
  text-decoration: none; cursor: pointer; border: none; font-family: var(--font);
  transition: all var(--duration) var(--ease);
}
.dial-btn:active { transform: scale(0.98); }
.dial-btn.idle { background: var(--accent); color: #fff; }
.dial-btn.idle:hover { background: var(--accent-hover); }
.dial-btn.calling { background: var(--success); color: #fff; animation: pulse 2s infinite; }
.dial-btn.ringing { background: var(--warning); color: #000; animation: pulse 1.5s infinite; }
.dial-btn.connected { background: var(--accent); color: #fff; }
.dial-btn.ended { background: var(--bg-surface); color: var(--text-tertiary); border: 1px solid var(--border); }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.8} }

.hangup-btn {
  display: block; width: 100%; padding: 10px; border-radius: var(--radius-md);
  background: var(--danger); color: #fff; font-weight: 600; font-size: 0.875rem;
  text-align: center; cursor: pointer; border: none; font-family: var(--font);
  margin-top: var(--sp-2); transition: all var(--duration) var(--ease);
}
.hangup-btn:hover { background: #dc2626; }
.call-timer {
  text-align: center; font-size: 0.85rem; color: var(--text-tertiary);
  margin-top: var(--sp-2); font-weight: 600; font-variant-numeric: tabular-nums;
}

/* Quick disposition */
.dispositions {
  padding: var(--sp-2) var(--sp-4); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.dispositions .label {
  font-size: 0.72rem; color: var(--text-tertiary); margin-bottom: var(--sp-2);
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
}
.disp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--sp-2); }
.disp-btn {
  padding: 10px 6px; border-radius: var(--radius-md); font-weight: 700;
  font-size: 0.82rem; cursor: pointer; font-family: var(--font);
  transition: all var(--duration) var(--ease); background: transparent;
}
.disp-btn:hover { transform: scale(1.02); }
.disp-btn:active { transform: scale(0.95); }

/* Nav controls */
.nav-controls {
  padding: var(--sp-2) var(--sp-4); display: flex; gap: var(--sp-2);
  border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.nav-btn {
  flex: 1; padding: 8px; border-radius: var(--radius-md);
  border: 1px solid var(--border); background: transparent;
  font-weight: 600; font-size: 0.8rem; cursor: pointer;
  font-family: var(--font); color: var(--text-secondary);
  transition: all var(--duration) var(--ease);
}
.nav-btn:hover { background: var(--bg-surface); border-color: var(--border-hover); }
.nav-btn:disabled { color: var(--bg-hover); cursor: not-allowed; }
.nav-btn.pause { border-color: var(--warning); color: var(--warning); }
.nav-btn.pause:hover { background: var(--warning-muted); }
.nav-btn.resume { border-color: var(--success); color: var(--success); }
.nav-btn.resume:hover { background: var(--success-muted); }
.nav-btn.stop { border-color: var(--danger); color: var(--danger); }
.nav-btn.stop:hover { background: var(--danger-muted); }

/* Script section */
.script-area {
  flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
  padding: var(--sp-3); padding-bottom: 56px;
  animation: fadeIn 0.3s var(--ease);
}
.script-step {
  margin-bottom: var(--sp-2); border-radius: var(--radius-md);
  background: var(--bg-surface); border: 1px solid var(--border); overflow: hidden;
  transition: border-color var(--duration) var(--ease);
}
.script-step:hover { border-color: var(--border-hover); }
.script-step-header {
  padding: var(--sp-3) var(--sp-4); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background var(--duration) var(--ease);
}
.script-step-header:hover { background: var(--bg-elevated); }
.script-step-header span:first-child { font-weight: 700; font-size: 0.88rem; }
.script-step-header .arrow {
  color: var(--text-tertiary); font-size: 0.9rem;
  transition: transform var(--duration) var(--ease);
  display: inline-block;
}
.script-step-header .arrow.open { transform: rotate(90deg); }
.script-step-body {
  overflow: hidden; transition: max-height var(--duration-slow) var(--ease);
}
.script-step-body-inner {
  padding: var(--sp-3) var(--sp-4); font-size: 0.9rem; line-height: 1.7;
  white-space: pre-wrap; color: var(--text-secondary);
  border-top: 1px solid var(--border);
}

/* ============================================================
   Session Summary
   ============================================================ */
.summary {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: var(--sp-5);
  animation: fadeIn 0.4s var(--ease);
}
.summary h2 {
  font-size: 1.5rem; font-weight: 800; margin-bottom: var(--sp-5);
  letter-spacing: -0.02em;
}
.summary-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-3);
  width: 100%; max-width: 320px; margin-bottom: var(--sp-6);
}
.summary-stat {
  text-align: center; padding: var(--sp-5);
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  transition: border-color var(--duration) var(--ease);
}
.summary-stat:hover { border-color: var(--border-hover); }
.summary-stat .num {
  font-size: 2rem; font-weight: 800; font-variant-numeric: tabular-nums;
}
.summary-stat .lbl { font-size: 0.78rem; color: var(--text-tertiary); margin-top: var(--sp-1); }

/* ============================================================
   Connection Status
   ============================================================ */
.conn-status {
  position: fixed; top: 8px; right: 8px; padding: 4px 12px;
  border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600;
  z-index: 150; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
}
.conn-status.connected { background: var(--success-muted); color: var(--success); }
.conn-status.disconnected { background: var(--danger-muted); color: var(--danger); }
.conn-status.connecting { background: var(--warning-muted); color: var(--warning); }

/* ============================================================
   Dialing Overlay â€” Full Screen
   ============================================================ */
.dial-overlay {
  position: fixed; inset: 0; z-index: 100;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: var(--bg-base);
  animation: fadeIn 0.3s var(--ease);
}

/* Pulsing rings */
.dial-rings {
  position: relative; width: 180px; height: 180px; margin-bottom: var(--sp-8);
}
.dial-ring {
  position: absolute; inset: 0; border-radius: 50%;
  border: 2px solid var(--accent); opacity: 0;
  animation: ringPulse 3s ease-out infinite;
}
.dial-ring:nth-child(2) { animation-delay: 0.6s; }
.dial-ring:nth-child(3) { animation-delay: 1.2s; }
.dial-ring:nth-child(4) { animation-delay: 1.8s; }
@keyframes ringPulse {
  0%   { transform: scale(0.5); opacity: 0.5; }
  100% { transform: scale(2); opacity: 0; }
}

/* Phone icon center */
.dial-icon {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 64px; height: 64px; background: var(--accent); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; box-shadow: var(--shadow-glow);
  transition: background var(--duration-slow) var(--ease);
}
.dial-name {
  font-size: 1.5rem; font-weight: 800; letter-spacing: -0.02em;
  margin-bottom: var(--sp-1);
}
.dial-phone {
  font-size: 1rem; color: var(--text-tertiary);
  font-variant-numeric: tabular-nums; margin-bottom: var(--sp-4);
}
.dial-meta { display: flex; gap: var(--sp-5); color: var(--text-secondary); font-size: 0.85rem; }
.dial-meta-item { display: flex; align-items: center; gap: var(--sp-1); }
.dial-state {
  margin-top: var(--sp-6); font-size: 0.8rem; font-weight: 700;
  letter-spacing: 0.12em; text-transform: uppercase;
}
.dial-state.calling { color: var(--accent); }
.dial-state.ringing { color: var(--warning); }
.dial-state.connected { color: var(--success); }

/* Ringing state â€” switch ring colors */
.dial-overlay.ringing .dial-ring { border-color: var(--warning); }
.dial-overlay.ringing .dial-icon { background: var(--warning); box-shadow: 0 0 30px rgba(234,179,8,0.2); }
/* Connected state â€” rings fade away */
.dial-overlay.connected .dial-ring { animation: none; opacity: 0; }
.dial-overlay.connected .dial-icon { background: var(--success); box-shadow: 0 0 30px rgba(34,197,94,0.2); }

.dial-overlay .hangup-btn {
  margin-top: var(--sp-8); width: 200px;
}

/* Dispositions on overlay */
.dial-overlay .dispositions {
  margin-top: var(--sp-5); padding: 0; border: none; width: 100%; max-width: 360px;
}

/* ============================================================
   Floating Stats Bar
   ============================================================ */
.stats-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 50;
  display: flex; justify-content: center; gap: var(--sp-5);
  padding: var(--sp-2) var(--sp-4);
  background: rgba(9,9,11,0.8);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  font-size: 0.75rem; font-weight: 600;
}
.stats-bar-item {
  display: flex; align-items: center; gap: var(--sp-1);
  color: var(--text-tertiary);
}
.stats-bar-item .num { color: var(--text-primary); font-variant-numeric: tabular-nums; }

/* ============================================================
   Auto-Advance Countdown
   ============================================================ */
.auto-advance-bar {
  padding: var(--sp-3) var(--sp-4); text-align: center;
  background: var(--accent-muted); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.auto-advance-bar .countdown-text {
  font-size: 0.85rem; font-weight: 600; color: var(--accent);
}
.auto-advance-progress {
  height: 3px; background: var(--bg-elevated);
  border-radius: var(--radius-full); margin-top: var(--sp-2); overflow: hidden;
}
.auto-advance-fill {
  height: 100%; background: var(--accent);
  border-radius: var(--radius-full); transition: width 1s linear;
}

/* ============================================================
   Animations
   ============================================================ */
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes slideUp { from{transform:translateY(12px);opacity:0} to{transform:translateY(0);opacity:1} }
</style>
</head>
<body>

<div id="app"></div>

<!-- Telnyx WebRTC SDK -->
<script src="https://unpkg.com/@telnyx/webrtc@2.9.0/lib/bundle.js"></script>

<script>
// ============================================================
// SKIPDIAL POWER DIALER â€” Telnyx WebRTC Edition
// ============================================================

// ===== CONFIG =====
const API_BASE = ''; // Same origin when deployed to Vercel. Change for local dev.

// ===== STATE =====
const STATE = {
  view: 'upload', // upload | list | calling | summary
  leads: [],
  queue: [],
  queueIdx: 0,
  called: new Set(),
  stats: { calls:0, vms:0, appts:0, sold:0, notint:0, bad:0, callbacks:0 },
  paused: false,
  search: '',
  openSteps: {},
  sheetName: '',
  // Telnyx
  telnyxClient: null,
  telnyxReady: false,
  currentCall: null,
  callState: 'idle', // idle | calling | ringing | connected | ended
  callTimer: 0,
  callTimerInterval: null,
  // AMD
  lastAMDResult: null,
  // Auto-advance
  autoAdvanceTimer: null,
  autoAdvanceCountdown: 0,
  dispositioned: false,
  // Ring tone
  ringToneCtx: null,
  ringToneTimer: null,
  isRingTonePlaying: false,
  // Dialing overlay
  showDialOverlay: true
};

// ===== CONSTANTS =====
const TZ={CT:-5,DE:-5,FL:-5,GA:-5,IN:-5,KY:-5,ME:-5,MD:-5,MA:-5,MI:-5,NH:-5,NJ:-5,NY:-5,NC:-5,OH:-5,PA:-5,RI:-5,SC:-5,VT:-5,VA:-5,WV:-5,DC:-5,AL:-6,AR:-6,IL:-6,IA:-6,KS:-6,LA:-6,MN:-6,MS:-6,MO:-6,NE:-6,ND:-6,OK:-6,SD:-6,TN:-6,TX:-6,WI:-6,AZ:-7,CO:-7,ID:-7,MT:-7,NM:-7,UT:-7,WY:-7,CA:-8,NV:-8,OR:-8,WA:-8,AK:-9,HI:-10};
const STNAMES={AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',CO:'Colorado',CT:'Connecticut',DE:'Delaware',FL:'Florida',GA:'Georgia',HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming',DC:'Washington DC'};
const STATUSES=['NEW LEAD','Follow Up','Scheduled Appt','1x VM','2x VM','3x VM','Bad #','Not Interested','SOLD','DNC','3x No VM','3x 5th round','Already Covered/Irreplaceable'];
const SBG={'SOLD':'#00B050','Scheduled Appt':'#92D050','3x VM':'#FFE699','Follow Up':'#FFF2CC','Bad #':'#FF0000','Not Interested':'#FFC7CE','NEW LEAD':'#DDEBF7','1x VM':'#FFF2CC','2x VM':'#FFE699','3x No VM':'#FFF2CC','3x 5th round':'#F4B084','Already Covered/Irreplaceable':'#C6E0B4','DNC':'#FF0000'};
const STX={'SOLD':'#fff','Bad #':'#fff','DNC':'#fff'};
const QBTNS=[{l:'ðŸ“± VM',s:'auto_vm',c:'#eab308'},{l:'ðŸ”„ Callback',s:'Follow Up',c:'#3b82f6'},{l:'âœ‹ Not Int',s:'Not Interested',c:'#ef4444'},{l:'âŒ Bad #',s:'Bad #',c:'#ef4444'},{l:'ðŸ“… Appt',s:'Scheduled Appt',c:'#10b981'},{l:'ðŸ’° SOLD',s:'SOLD',c:'#10b981'}];

// ===== HELPERS =====
function $(id){return document.getElementById(id)}
function cw(s){const o=TZ[s]||-5,n=new Date(),u=n.getTime()+(n.getTimezoneOffset()*60000),m=n.getMonth(),d=(m>=2&&m<=10&&s!=='AZ'&&s!=='HI')?1:0,t=new Date(u+((o+d)*3600000)),h=t.getHours(),ts=t.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});if(h<8)return{s:0,l:'ðŸŒ™',t:ts,c:'#ef4444'};if(h<10)return{s:10,l:'ðŸ”¥',t:ts,c:'#10b981'};if(h<12)return{s:9,l:'âœ…',t:ts,c:'#10b981'};if(h<14)return{s:7,l:'ðŸ½ï¸',t:ts,c:'#eab308'};if(h<17)return{s:8,l:'âœ…',t:ts,c:'#3b82f6'};if(h<19)return{s:6,l:'ðŸŒ…',t:ts,c:'#f59e0b'};if(h<21)return{s:3,l:'ðŸŒ†',t:ts,c:'#f97316'};return{s:0,l:'ðŸ›‘',t:ts,c:'#ef4444'};}
function fmt(p){const d=(p||'').replace(/\D/g,'').replace(/^1/,'');return d.length===10?`(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`:p;}
function fn(n){return(n||'').split(' ')[0];}
function e164(p){return'+1'+(p||'').replace(/\D/g,'').replace(/^1/,'');}

let toastTimer;
function showToast(msg, isError){
  let t = $('toast');
  if(!t){t=document.createElement('div');t.id='toast';t.className='toast hidden';document.body.appendChild(t);}
  t.textContent=msg;
  t.className='toast'+(isError?' error':'');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.className='toast hidden',2500);
}

// ===== STATUS STYLE HELPER (dark theme mapping) =====
function statusStyle(status) {
  const map = {
    'SOLD':       { bg: 'var(--success-muted)', color: 'var(--success)' },
    'Scheduled Appt': { bg: 'var(--success-muted)', color: 'var(--success)' },
    'NEW LEAD':   { bg: 'var(--accent-muted)', color: 'var(--accent)' },
    'Follow Up':  { bg: 'var(--warning-muted)', color: 'var(--warning)' },
    '1x VM':      { bg: 'var(--warning-muted)', color: 'var(--warning)' },
    '2x VM':      { bg: 'var(--warning-muted)', color: 'var(--warning)' },
    '3x VM':      { bg: 'var(--orange-muted)', color: 'var(--orange)' },
    'Bad #':      { bg: 'var(--danger-muted)', color: 'var(--danger)' },
    'Not Interested': { bg: 'var(--danger-muted)', color: 'var(--danger)' },
    'DNC':        { bg: 'var(--danger-muted)', color: 'var(--danger)' },
    '3x No VM':   { bg: 'var(--orange-muted)', color: 'var(--orange)' },
    '3x 5th round': { bg: 'var(--orange-muted)', color: 'var(--orange)' },
    'Already Covered/Irreplaceable': { bg: 'var(--success-muted)', color: 'var(--success)' },
  };
  return map[status] || { bg: 'var(--bg-elevated)', color: 'var(--text-secondary)' };
}

// ===== CSV PARSER =====
function parseCSV(text){
  const L=text.split(/\r?\n/).filter(l=>l.trim());if(L.length<2)return[];
  const sep=L[0].includes('\t')?'\t':',';
  const H=L[0].split(sep).map(h=>h.replace(/"/g,'').trim().toUpperCase());
  const ni=H.findIndex(h=>h.includes('NAME')),pi=H.findIndex(h=>h.includes('PHONE')),di=H.findIndex(h=>h.includes('DOB')),si=H.findIndex(h=>h.includes('STATE')),sti=H.findIndex(h=>h.includes('STATUS')),noi=H.findIndex(h=>h.includes('NOTE'));
  if(ni<0||pi<0)return[];
  const R=[];
  for(let i=1;i<L.length;i++){
    const c=L[i].split(sep).map(x=>x.replace(/"/g,'').trim());
    const nm=c[ni]||'',ph=(c[pi]||'').replace(/\D/g,'');
    if(!nm||!ph||ph.length<7)continue;
    const db=di>=0?c[di]:'',st=si>=0?(c[si]||'').toUpperCase().substring(0,2):'',ss=sti>=0?(c[sti]||'NEW LEAD'):'NEW LEAD',no=noi>=0?(c[noi]||''):'';
    let a=0;if(db){const p=db.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);if(p){let y=parseInt(p[3]);if(y<100)y+=y>25?1900:2000;a=Math.floor((Date.now()-new Date(y,parseInt(p[1])-1,parseInt(p[2])).getTime())/(365.25*86400000));}}
    R.push({id:crypto.randomUUID(),name:nm,phone:ph,dob:db,age:a,state:st,status:STATUSES.find(x=>x.toLowerCase()===ss.toLowerCase().trim())||'NEW LEAD',notes:no,vm:0});
  }
  return R;
}

// ===== TELNYX CLIENT =====
async function initTelnyx(){
  try {
    showToast('Connecting to dialer...');
    const res = await fetch(API_BASE + '/api/token');
    if(!res.ok) throw new Error('Token fetch failed');
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const client = new TelnyxWebRTC.TelnyxRTC({
      login_token: data.token
    });

    client.on('telnyx.ready', () => {
      STATE.telnyxReady = true;
      showToast('Dialer connected');
      render();
    });

    client.on('telnyx.error', (err) => {
      console.error('Telnyx error:', err);
      STATE.telnyxReady = false;
      showToast('Dialer connection error', true);
      render();
    });

    client.on('telnyx.notification', (notification) => {
      handleTelnyxNotification(notification);
    });

    client.on('telnyx.socket.close', () => {
      STATE.telnyxReady = false;
      render();
    });

    client.connect();
    STATE.telnyxClient = client;
  } catch(err) {
    console.error('Telnyx init error:', err);
    showToast('Failed to connect dialer: ' + err.message, true);
  }
}

function handleTelnyxNotification(notification) {
  const call = notification.call;
  if (!call) return;

  switch(notification.type) {
    case 'callUpdate':
      if (call.state === 'ringing') {
        STATE.callState = 'ringing';
        startRingTone();
      } else if (call.state === 'active') {
        STATE.callState = 'connected';
        stopRingTone();
        startCallTimer();
        STATE.showDialOverlay = false;
      } else if (call.state === 'hangup' || call.state === 'destroy') {
        STATE.callState = 'ended';
        stopRingTone();
        stopCallTimer();
        STATE.currentCall = null;
        if (!STATE.dispositioned) {
          startAutoAdvance();
        }
      }
      render();
      break;
  }
}

function dialNumber(phoneNumber) {
  STATE.showDialOverlay = true;
  STATE.dispositioned = false;

  if (!STATE.telnyxClient || !STATE.telnyxReady) {
    // Fallback to tel: link if WebRTC not connected
    window.location.href = 'tel:' + e164(phoneNumber);
    STATE.callState = 'calling';
    startRingTone();
    render();
    return;
  }

  try {
    STATE.callState = 'calling';
    startRingTone();
    render();

    const call = STATE.telnyxClient.newCall({
      destinationNumber: e164(phoneNumber),
      callerName: 'SkipDial',
      callerNumber: '', // Will use the Telnyx number
    });

    STATE.currentCall = call;
  } catch(err) {
    console.error('Dial error:', err);
    stopRingTone();
    showToast('Dial failed: ' + err.message, true);
    STATE.callState = 'idle';
    STATE.showDialOverlay = false;
    render();
  }
}

function hangupCall() {
  if (STATE.currentCall) {
    try { STATE.currentCall.hangup(); } catch(e) {}
    STATE.currentCall = null;
  }
  STATE.callState = 'ended';
  stopRingTone();
  stopCallTimer();
  render();
}

function startCallTimer(){
  STATE.callTimer = 0;
  clearInterval(STATE.callTimerInterval);
  STATE.callTimerInterval = setInterval(()=>{
    STATE.callTimer++;
    const el = $('callTimer');
    if(el){
      const m=Math.floor(STATE.callTimer/60);
      const s=STATE.callTimer%60;
      el.textContent=`${m}:${s<10?'0':''}${s}`;
    }
  },1000);
}

function stopCallTimer(){
  clearInterval(STATE.callTimerInterval);
}

// ===== RING TONE (Web Audio API) =====
function startRingTone() {
  if (STATE.isRingTonePlaying) return;
  try {
    if (!STATE.ringToneCtx) {
      STATE.ringToneCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (STATE.ringToneCtx.state === 'suspended') {
      STATE.ringToneCtx.resume();
    }
    STATE.isRingTonePlaying = true;
    playRingCycle();
  } catch(e) {
    console.warn('Ring tone unavailable:', e);
  }
}

function playRingCycle() {
  if (!STATE.isRingTonePlaying) return;
  const ctx = STATE.ringToneCtx;
  try {
    const gain = ctx.createGain();
    gain.gain.value = 0.12;
    gain.connect(ctx.destination);

    const osc1 = ctx.createOscillator();
    osc1.frequency.value = 440;
    osc1.type = 'sine';
    osc1.connect(gain);

    const osc2 = ctx.createOscillator();
    osc2.frequency.value = 480;
    osc2.type = 'sine';
    osc2.connect(gain);

    const now = ctx.currentTime;
    osc1.start(now);
    osc2.start(now);
    osc1.stop(now + 2);
    osc2.stop(now + 2);

    // 2s ring + 4s silence = 6s cycle
    STATE.ringToneTimer = setTimeout(() => playRingCycle(), 6000);
  } catch(e) {
    console.warn('Ring cycle error:', e);
  }
}

function stopRingTone() {
  STATE.isRingTonePlaying = false;
  clearTimeout(STATE.ringToneTimer);
  STATE.ringToneTimer = null;
}

// ===== AUTO-ADVANCE =====
function startAutoAdvance() {
  clearAutoAdvance();
  STATE.autoAdvanceCountdown = 3;
  render();

  STATE.autoAdvanceTimer = setInterval(() => {
    STATE.autoAdvanceCountdown--;
    if (STATE.autoAdvanceCountdown <= 0) {
      clearAutoAdvance();
      advanceToNextLead();
    } else {
      render();
    }
  }, 1000);
}

function clearAutoAdvance() {
  if (STATE.autoAdvanceTimer) {
    clearInterval(STATE.autoAdvanceTimer);
    STATE.autoAdvanceTimer = null;
  }
  STATE.autoAdvanceCountdown = 0;
}

function advanceToNextLead() {
  const ni = STATE.queueIdx + 1;
  if (ni < STATE.queue.length && !STATE.paused) {
    STATE.queueIdx = ni;
    STATE.openSteps = {};
    STATE.callState = 'idle';
    STATE.dispositioned = false;
    STATE.showDialOverlay = true;
    render();
    const nl = STATE.leads.find(l => l.id === STATE.queue[ni]);
    if (nl) {
      STATE.called.add(STATE.queue[ni]);
      setTimeout(() => dialNumber(nl.phone), 300);
    }
  } else if (ni >= STATE.queue.length) {
    STATE.view = 'summary';
    render();
  } else {
    render();
  }
}

// ===== SCRIPT GENERATOR =====
function genScript(l){
  const f=fn(l.name),full=l.name,stF=STNAMES[l.state]||l.state,dob=l.dob||'___',age=l.age;
  let tone=age>=75?`${f}, you've served this country and earned peace of mind.`:age>=65?`${f}, perfect age to lock this in while rates are in your favor.`:age>=55?`${f}, you're getting ahead of this â€” most people wait until it's too late.`:`${f}, rates only go up from here.`;
  return[
{title:'ðŸ“ž Intro',body:`Hey ${f}, this is _(your name)_ with the Veterans Benefits Office. You doing alright today?\n\nJust giving you a call about Final Expense and Life options for Veterans. I've got your DOB as ${dob}. Is that correct?\n\nAnd you're still in ${stF}, correct?\n\nYour main concern was making sure funeral expense doesn't burden your loved ones, correct?`},
{title:'ðŸ›¡ï¸ Intro Objections',collapsed:true,body:`"10th person that called me!"\nMust have been a telemarketer â€” nobody contacted you from our office.\n\n"Already have coverage!"\nPerfect â€” Veteran benefit office or private? How much? What paying/month?\n\n"Don't remember filling this out!"\nI usually don't remember breakfast! DOB as ${dob}, correct?\n\n"Not interested!"\nWhat was your main concern when you sent the request? Any coverage currently?\n\n"Not a good time!"\nWe're backed up too! I'll make this quick.\n\n"VA will take care of burial"\nCommon misconception. VA just covers the plot. Avg burial $12Kâ€“$25K, cremation $5Kâ€“$8K.\n\n"Send me info"\nNothing to send yet â€” every plan differs. Takes a few minutes. Fair enough?\n\n"Is this a scam?"\nFair question. Licensed agent in ${stF}. A-rated carriers.`},
{title:'ðŸ’¡ Dig Into The Why',body:`God forbid you passed today â€” who'd be responsible for funeral expenses?\n\nâ€¢ Name? Spell that?\nâ€¢ Is (beneficiary) in a position to cover it?\n\n${tone}\n\nBuried or cremated? Know how much?\nâ€¢ Cremation: $5Kâ€“$8K\nâ€¢ Burial: $12Kâ€“$25K\n\nAnything put aside?\n\nðŸ”‘ Your goal is to not leave a financial burden behind, correct?`},
{title:'ðŸ“‹ Suitability',body:`1. Working, retired, or disabled?\n2. Bring in per month ballpark?\n3. Left with after bills?\n\nLow income: "If you can't afford $50-75/mo how do you expect (Beneficiary) to afford the funeral?"\n\nTwo DISCOUNTS:\n1. Smoker or nonsmoker?\n2. Military credit union or state/federal bank?`},
{title:'ðŸ¥ Health Questions',body:`VA or civilian doctor?\n\nâ€¢ Heart attacks, strokes, stents last 5 yrs?\nâ€¢ Cancer last 5 years?\nâ€¢ Diabetes? Metformin/insulin?\nâ€¢ Neuropathy? Gabapentin?\nâ€¢ COPD? Oxygen/inhaler?\nâ€¢ Kidney/liver problems? Dialysis?\nâ€¢ Height and weight?\n\n"Running this through all the carriers for cheapest rate..."`},
{title:'âœ… Benefits â€” Pen & Paper',body:`1. IMMEDIATE COVERAGE â€” day 1, no 2yr wait!\n2. LOCKED IN â€” never increases, never decreases!\n3. TAX-FREE â€” death benefit, living benefit, cash value!\n4. LIVING BENEFIT â€” terminal illness, 50% tax free!\n5. DOUBLE ACCIDENTAL â€” choke, drown, slip, fall = double!\n6. PERMANENT â€” whole life, never expires!`},
{title:'ðŸ’° Quote',body:`ðŸ¥‰ BRONZE â€” covers full funeral. $___/mo.\n\nðŸ¥ˆ SILVER â€” extra for bills + inflation. $___/mo.\n\nðŸ¥‡ GOLD â€” (Beneficiary) fully taken care of. $___/mo.\n\nðŸ”‘ Which fits you best? BRONZE... SILVER... OR GOLD?`},
{title:'ðŸ›¡ï¸ Quote Objections',collapsed:true,body:`"Think about it" â†’ Need it or which amount? Start bare minimum.\n\n"Talk to wife" â†’ She's beneficiary. Paperwork in 7-10 days. If something happened tomorrow â€” would she be mad?\n\n"Shopping around" â†’ Can't buy today anyway. Have to get approved. Lowest rate.\n\n"No money" â†’ When do you get benefits? Effective date matches. Nothing today.\n\n"Call you back" â†’ Rates locked by age. 30-day free look, full refund.\n\n"Too expensive" â†’ Which package? Bronze = less than a cable bill.`},
{title:'ðŸ“ Application',body:`ðŸ”‘ Been thinking about this for awhile?\n\nâ€¢ Spelling: ${full}\nâ€¢ Height/weight\nâ€¢ Address (house/apt?)\nâ€¢ Phone, email\nâ€¢ State & city born in\nâ€¢ US Citizen! (joke)\nâ€¢ Social ${f}? (Repeat back)\n\nSSN: "For medical background check + death certificate to pay (Beneficiary)."\nPush: "Confirm the last four."`},
{title:'ðŸ¥ Health Fillers',body:`â€¢ Help walking? Cane/wheelchair?\nâ€¢ Oxygen?\nâ€¢ Help with daily activities?\nâ€¢ COVID last 90 days?\nâ€¢ Alcohol/drug abuse?\nâ€¢ Alzheimers/Dementia?\nâ€¢ AIDS/HIV? Hepatitis?\nâ€¢ Brain tumor/aneurysm?\nâ€¢ Dangerous activities next 2 years?`},
{title:'â¤ï¸ Beneficiary',body:`Confirm beneficiary, spelling, relationship, DOB, %\n\nSPOUSE: How long married? Tips? Grandkids?\nCHILD: See them often? Grandkids?\n\nðŸ”‘ What got you thinking about this for (beneficiary)?`},
{title:'ðŸ’³ Billing',body:`When do you get benefits? Set effective date.\n\nâ€¢ Name same with bank?\nâ€¢ Bank name? Checking/savings?\nâ€¢ Checkbook â€” confirm routing\nâ€¢ Account #? REPEAT TWICE.\n\nNo checkbook â†’ debit card for now.\n\nObjection: "Ever given a check? That info can't buy anything online."\n\n"Don't give bank info" â†’ Secure link or debit card.`},
{title:'ðŸ”’ Close + Referrals',body:`Everything submitted. Coverage for _XXX_, carrier _XXX_.\n\nThis is my direct line. Phone call or text away.\n\nPolicy in mail 10-12 days. I'll text you.\n\n$50 VISA referral fee â€” know one or two people?\n\nAny questions? Blessed day!`}
  ];
}

// ===== QUEUE LOGIC =====
function buildQueue(){
  const skip=['SOLD','Bad #','Not Interested','DNC','Already Covered/Irreplaceable'];
  return STATE.leads.filter(l=>!skip.includes(l.status)&&cw(l.state).s>0).map(l=>l.id);
}

function startDialing(fromId){
  const q=buildQueue();
  if(!q.length){showToast('No callable leads');return;}
  const si=fromId?Math.max(q.indexOf(fromId),0):0;
  STATE.queue=q;STATE.queueIdx=si;STATE.called=new Set();
  STATE.stats={calls:0,vms:0,appts:0,sold:0,notint:0,bad:0,callbacks:0};
  STATE.paused=false;STATE.openSteps={};STATE.callState='idle';
  STATE.dispositioned=false;STATE.showDialOverlay=true;STATE.autoAdvanceCountdown=0;
  STATE.view='calling';
  render();
  // Auto-dial first lead
  setTimeout(()=>{
    const lead=STATE.leads.find(x=>x.id===q[si]);
    if(lead){
      STATE.called.add(q[si]);
      dialNumber(lead.phone);
    }
  },500);
}

function disposition(status){
  const lid=STATE.queue[STATE.queueIdx];
  const lead=STATE.leads.find(l=>l.id===lid);
  if(!lead)return;

  STATE.dispositioned=true;
  clearAutoAdvance();

  // Hangup current call if active
  hangupCall();

  let ns=status;
  if(status==='auto_vm'){lead.vm=(lead.vm||0)+1;ns=lead.vm===1?'1x VM':lead.vm===2?'2x VM':'3x VM';}
  lead.status=ns;
  STATE.called.add(lid);

  // Update stats
  STATE.stats.calls++;
  if(ns.includes('VM'))STATE.stats.vms++;
  if(ns==='Scheduled Appt')STATE.stats.appts++;
  if(ns==='SOLD')STATE.stats.sold++;
  if(ns==='Not Interested')STATE.stats.notint++;
  if(ns==='Bad #')STATE.stats.bad++;
  if(ns==='Follow Up')STATE.stats.callbacks++;

  showToast(`${fn(lead.name)} â†’ ${ns}`);

  // Immediate advance
  STATE.showDialOverlay=true;
  advanceToNextLead();
}

function skipLead(){
  clearAutoAdvance();
  hangupCall();
  STATE.showDialOverlay=true;
  STATE.dispositioned=false;
  const ni=STATE.queueIdx+1;
  if(ni<STATE.queue.length){
    STATE.queueIdx=ni;STATE.openSteps={};STATE.callState='idle';render();
    const nl=STATE.leads.find(l=>l.id===STATE.queue[ni]);
    if(nl)setTimeout(()=>dialNumber(nl.phone),300);
  }
}

function stopDialer(){
  clearAutoAdvance();
  stopRingTone();
  hangupCall();
  STATE.view='summary';
  render();
}

// ===== RENDER =====
function render(){
  const app=$('app');
  if(STATE.view==='upload') return renderUpload(app);
  if(STATE.view==='list') return renderList(app);
  if(STATE.view==='calling') return renderCalling(app);
  if(STATE.view==='summary') return renderSummary(app);
}

function connStatusHTML(){
  if(!STATE.telnyxClient) return '<div class="conn-status disconnected">Not Connected</div>';
  if(STATE.telnyxReady) return '<div class="conn-status connected">Connected</div>';
  return '<div class="conn-status connecting">Connecting...</div>';
}

// ===== RENDER: UPLOAD =====
function renderUpload(app){
  app.innerHTML=`
    <div class="upload-view">
      <h1>Skip<span>Dial</span></h1>
      <p>Power dialer + live script. Upload your CSV to start.</p>
      <div class="upload-box" onclick="document.getElementById('csvFile').click()">
        <div class="icon">
          <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
          </svg>
        </div>
        <div class="label">Upload CSV</div>
        <div class="hint">NAME, PHONE, DOB, STATE, STATUS</div>
        <input type="file" id="csvFile" accept=".csv,.tsv,.txt" style="display:none" onchange="handleFile(event)">
      </div>
      <div class="demo-link" onclick="loadDemo()">Load demo data</div>
    </div>
    ${connStatusHTML()}
  `;
}

// ===== RENDER: LIST =====
function renderList(app){
  const fl=STATE.search?STATE.leads.filter(l=>l.name.toLowerCase().includes(STATE.search.toLowerCase())||l.state.toLowerCase().includes(STATE.search.toLowerCase())):STATE.leads;
  const nc=buildQueue().length;
  app.innerHTML=`
    <div class="list-header">
      <h2><span>${STATE.sheetName||'Leads'}</span></h2>
      <span class="count">${STATE.leads.length} leads</span>
    </div>
    <div class="list-actions">
      <button class="btn btn-primary" onclick="startDialing()">Power Dial (${nc})</button>
      <button class="btn btn-ghost" onclick="STATE.view='upload';STATE.leads=[];render()">+ New</button>
    </div>
    <div class="search-bar">
      <div class="search-wrap">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path stroke-linecap="round" d="M21 21l-4.35-4.35"/>
        </svg>
        <input id="searchInput" placeholder="Search leads..." value="${STATE.search}" oninput="STATE.search=this.value;render()">
      </div>
    </div>
    <div class="lead-list">
      ${fl.map(l=>{
        const w=cw(l.state);
        const ss=statusStyle(l.status);
        return`<div class="lead-row" onclick="startDialing('${l.id}')">
          <div class="lead-info">
            <div class="lead-name">${l.name}</div>
            <div class="lead-meta">${l.age>0?l.age+'yo Â· ':''}${l.state} Â· ${fmt(l.phone)}</div>
          </div>
          <div class="lead-right">
            <div class="lead-time" style="color:${w.c}">${w.l} ${w.t}</div>
            <div class="lead-status" style="background:${ss.bg};color:${ss.color}">${l.status}</div>
          </div>
        </div>`;
      }).join('')}
    </div>
    ${connStatusHTML()}
  `;
}

// ===== RENDER: DIALING OVERLAY =====
function renderDialOverlay(lead){
  const w=cw(lead.state);
  const stateClass=STATE.callState;
  const stateLabel=STATE.callState==='calling'?'DIALING':STATE.callState==='ringing'?'RINGING':STATE.callState==='connected'?'CONNECTED':'';

  return `
    <div class="dial-overlay ${stateClass}" id="dialOverlay">
      <div class="dial-rings">
        <div class="dial-ring"></div>
        <div class="dial-ring"></div>
        <div class="dial-ring"></div>
        <div class="dial-ring"></div>
        <div class="dial-icon">ðŸ“ž</div>
      </div>
      <div class="dial-name">Dialing ${lead.name}...</div>
      <div class="dial-phone">${fmt(lead.phone)}</div>
      <div class="dial-meta">
        ${lead.age>0?`<span class="dial-meta-item">Age ${lead.age}</span>`:''}
        ${lead.state?`<span class="dial-meta-item">${STNAMES[lead.state]||lead.state}</span>`:''}
        <span class="dial-meta-item" style="color:${w.c}">${w.l} ${w.t}</span>
      </div>
      <div class="dial-state ${stateClass}">${stateLabel}</div>
      <button class="hangup-btn" onclick="hangupCall()">End Call</button>
      <div class="dispositions">
        <div class="label">Quick Disposition</div>
        <div class="disp-grid">
          ${QBTNS.map(b=>`<button class="disp-btn" style="border:1.5px solid ${b.c};color:${b.c}" onclick="disposition('${b.s}')">${b.l}</button>`).join('')}
        </div>
      </div>
    </div>
  `;
}

// ===== RENDER: STATS BAR =====
function renderStatsBar(){
  const s=STATE.stats;
  return `
    <div class="stats-bar">
      <div class="stats-bar-item"><span class="num">${s.calls}</span> calls</div>
      <div class="stats-bar-item"><span class="num" style="color:var(--warning)">${s.vms}</span> VMs</div>
      <div class="stats-bar-item"><span class="num" style="color:var(--success)">${s.appts}</span> appts</div>
      <div class="stats-bar-item"><span class="num" style="color:var(--success)">${s.sold}</span> sold</div>
    </div>
  `;
}

// ===== RENDER: CALLING =====
function renderCalling(app){
  const cur=STATE.queue[STATE.queueIdx]?STATE.leads.find(l=>l.id===STATE.queue[STATE.queueIdx]):null;
  if(!cur){STATE.view='summary';render();return;}
  const w=cw(cur.state);
  const pct=STATE.queue.length?Math.round((STATE.called.size/STATE.queue.length)*100):0;
  const script=genScript(cur);
  const cs=STATE.callState;

  // Show overlay during dialing/ringing
  const showOverlay=STATE.showDialOverlay&&(cs==='calling'||cs==='ringing');

  // Auto-advance countdown
  const showCountdown=cs==='ended'&&!STATE.dispositioned&&STATE.autoAdvanceCountdown>0;

  let dialBtnClass='dial-btn idle';
  let dialBtnText=fmt(cur.phone);
  if(cs==='calling'){dialBtnClass='dial-btn calling';dialBtnText='Dialing...';}
  if(cs==='ringing'){dialBtnClass='dial-btn ringing';dialBtnText='Ringing...';}
  if(cs==='connected'){dialBtnClass='dial-btn connected';dialBtnText='Connected';}
  if(cs==='ended'){dialBtnClass='dial-btn ended';dialBtnText='Call Ended';}

  app.innerHTML=`
    ${showOverlay?renderDialOverlay(cur):''}

    <div class="call-header">
      <div class="call-header-top">
        <span class="power-label">Power Dialer</span>
        <span class="lead-num">${STATE.queueIdx+1} / ${STATE.queue.length}</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="call-stats">
        <span>${STATE.called.size} called</span>
        <span>${STATE.stats.appts} appts Â· ${STATE.stats.sold} sold Â· ${STATE.stats.vms} VMs</span>
      </div>
    </div>

    ${showCountdown?`
      <div class="auto-advance-bar">
        <div class="countdown-text">Next lead in ${STATE.autoAdvanceCountdown}...</div>
        <div class="auto-advance-progress">
          <div class="auto-advance-fill" style="width:${((3-STATE.autoAdvanceCountdown)/3)*100}%"></div>
        </div>
      </div>
    `:''}

    <div class="lead-card">
      <div class="name">${cur.name}</div>
      <div class="details">
        ${cur.age>0?'Age '+cur.age+' &middot; ':''}${STNAMES[cur.state]||cur.state}
        <span style="color:${w.c};font-weight:700">&middot; ${w.l} ${w.t}</span>
      </div>
      ${cur.notes?'<div class="notes">'+cur.notes+'</div>':''}
    </div>

    <div class="call-control">
      <button class="${dialBtnClass}" onclick="${cs==='idle'||cs==='ended'?`dialNumber('${cur.phone}')`:''}">
        ${dialBtnText}
      </button>
      ${cs==='connected'||cs==='calling'||cs==='ringing'?'<button class="hangup-btn" onclick="hangupCall()">Hang Up</button>':''}
      ${cs==='connected'?'<div class="call-timer" id="callTimer">0:00</div>':''}
    </div>

    <div class="dispositions">
      <div class="label">${cs==='ended'&&!STATE.dispositioned?'Optional â€” auto-advancing...':'Disposition'}</div>
      <div class="disp-grid">
        ${QBTNS.map(b=>`<button class="disp-btn" style="border:1.5px solid ${b.c};color:${b.c}" onclick="disposition('${b.s}')">${b.l}</button>`).join('')}
      </div>
    </div>

    <div class="nav-controls">
      <button class="nav-btn" onclick="if(STATE.queueIdx>0){clearAutoAdvance();hangupCall();STATE.queueIdx--;STATE.openSteps={};STATE.callState='idle';STATE.showDialOverlay=true;render();const p=STATE.leads.find(l=>l.id===STATE.queue[STATE.queueIdx]);if(p)setTimeout(()=>dialNumber(p.phone),300);}" ${STATE.queueIdx<=0?'disabled':''}>Prev</button>
      <button class="nav-btn" onclick="skipLead()" ${STATE.queueIdx>=STATE.queue.length-1?'disabled':''}>Skip</button>
      <button class="nav-btn ${STATE.paused?'resume':'pause'}" onclick="STATE.paused=!STATE.paused;if(STATE.paused)clearAutoAdvance();render()">${STATE.paused?'Resume':'Pause'}</button>
      <button class="nav-btn stop" onclick="clearAutoAdvance();stopDialer()">Stop</button>
    </div>

    ${cs==='connected'?`
      <div class="script-area">
        ${script.map((s,i)=>{
          const isOpen=s.collapsed?!!STATE.openSteps[i]:STATE.openSteps[i]!==false;
          return`<div class="script-step">
            <div class="script-step-header" onclick="STATE.openSteps[${i}]=${isOpen?'false':'true'};render()">
              <span>${s.title}</span>
              <span class="arrow ${isOpen?'open':''}">&rsaquo;</span>
            </div>
            <div class="script-step-body" style="max-height:${isOpen?'2000px':'0'}">
              <div class="script-step-body-inner">${s.body}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
    `:''}

    ${renderStatsBar()}
    ${connStatusHTML()}
  `;
}

// ===== RENDER: SUMMARY =====
function renderSummary(app){
  const s=STATE.stats;
  app.innerHTML=`
    <div class="summary">
      <h2>Session Complete</h2>
      <div class="summary-grid">
        <div class="summary-stat"><div class="num" data-target="${s.calls}" style="color:var(--accent)">0</div><div class="lbl">Total Calls</div></div>
        <div class="summary-stat"><div class="num" data-target="${s.vms}" style="color:var(--warning)">0</div><div class="lbl">Voicemails</div></div>
        <div class="summary-stat"><div class="num" data-target="${s.appts}" style="color:var(--success)">0</div><div class="lbl">Appointments</div></div>
        <div class="summary-stat"><div class="num" data-target="${s.sold}" style="color:var(--success)">0</div><div class="lbl">Sold</div></div>
        <div class="summary-stat"><div class="num" data-target="${s.callbacks}" style="color:var(--accent)">0</div><div class="lbl">Callbacks</div></div>
        <div class="summary-stat"><div class="num" data-target="${s.notint+s.bad}" style="color:var(--danger)">0</div><div class="lbl">Dead Leads</div></div>
      </div>
      <button class="btn btn-ghost" onclick="STATE.view='list';render()" style="width:100%;max-width:300px;margin-bottom:10px">Back to Leads</button>
      <button class="btn btn-primary" onclick="startDialing()" style="width:100%;max-width:300px">Dial Again</button>
    </div>
  `;
  animateCounters();
}

function animateCounters(){
  const els=document.querySelectorAll('.summary-stat .num[data-target]');
  els.forEach(el=>{
    const target=parseInt(el.dataset.target)||0;
    if(target===0)return;
    const duration=800;
    const start=performance.now();
    function tick(now){
      const elapsed=now-start;
      const progress=Math.min(elapsed/duration,1);
      const eased=1-Math.pow(1-progress,3);
      el.textContent=Math.round(eased*target);
      if(progress<1)requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  });
}

// ===== FILE HANDLING =====
function handleFile(e){
  const file=e.target.files[0];if(!file)return;
  STATE.sheetName=file.name.replace(/\.(csv|xlsx?|tsv|txt)$/i,'');
  const reader=new FileReader();
  reader.onload=ev=>{
    const parsed=parseCSV(ev.target.result);
    if(!parsed.length){showToast('No leads found â€” check CSV format',true);return;}
    parsed.sort((a,b)=>(cw(b.state).s-cw(a.state).s)||(b.age-a.age));
    STATE.leads=parsed;STATE.view='list';
    showToast(`${parsed.length} leads loaded`);
    render();
    // Try to connect to Telnyx after loading leads
    if(!STATE.telnyxClient) initTelnyx();
  };
  reader.readAsText(file);
}

function loadDemo(){
  const d=[
    {id:'1',name:'Robert Johnson',phone:'5551234567',dob:'03/15/1948',age:77,state:'FL',status:'NEW LEAD',notes:'Wife Linda',vm:0},
    {id:'2',name:'James Williams',phone:'5559876543',dob:'07/22/1955',age:70,state:'TX',status:'Follow Up',notes:'COPD',vm:0},
    {id:'3',name:'William Davis',phone:'5552345678',dob:'11/03/1950',age:75,state:'CA',status:'NEW LEAD',notes:'',vm:0},
    {id:'4',name:'Charles Smith',phone:'5553456789',dob:'01/18/1960',age:66,state:'GA',status:'NEW LEAD',notes:'',vm:0},
    {id:'5',name:'Thomas Brown',phone:'5554567890',dob:'09/30/1952',age:73,state:'NC',status:'Follow Up',notes:'',vm:0},
    {id:'6',name:'Donald Taylor',phone:'5556789012',dob:'06/25/1958',age:67,state:'PA',status:'NEW LEAD',notes:'',vm:0},
    {id:'7',name:'Kenneth Martinez',phone:'5558901234',dob:'08/14/1945',age:80,state:'AL',status:'NEW LEAD',notes:'Vietnam',vm:0},
    {id:'8',name:'Mark Thompson',phone:'5551237890',dob:'05/20/1968',age:57,state:'AZ',status:'NEW LEAD',notes:'',vm:0},
  ];
  d.sort((a,b)=>cw(b.state).s-cw(a.state).s||(b.age-a.age));
  STATE.leads=d;STATE.sheetName='Demo';STATE.view='list';
  render();
  if(!STATE.telnyxClient) initTelnyx();
}

// ===== INIT =====
render();
</script>
</body>
</html>
